#include "../../meta/root.C"
#include "../../meta/root6tools.C"
#include "../../meta/stl.C"
#include "../../helpers/graphics.C"
#include "../../struct/Ratio.cxx"

TH1 *makeRatioElianeR02R03(){
        std::cout << "Calling ratio 0.3" << std::endl;

   Double_t xAxis9[10] = {20, 30, 40, 50, 60, 70, 80, 100, 120, 140}; 
   
   TH1D *hJetShapeErrRatio0_Combined_copy__11 = new TH1D("ratio03","Unfold hResponseMatrixMain",9, xAxis9);
   hJetShapeErrRatio0_Combined_copy__11->SetBinContent(1,0.5862957);
   hJetShapeErrRatio0_Combined_copy__11->SetBinContent(2,0.6360389);
   hJetShapeErrRatio0_Combined_copy__11->SetBinContent(3,0.6865204);
   hJetShapeErrRatio0_Combined_copy__11->SetBinContent(4,0.7177847);
   hJetShapeErrRatio0_Combined_copy__11->SetBinContent(5,0.728344);
   hJetShapeErrRatio0_Combined_copy__11->SetBinContent(6,0.7515344);
   hJetShapeErrRatio0_Combined_copy__11->SetBinContent(7,0.7578066);
   hJetShapeErrRatio0_Combined_copy__11->SetBinContent(8,0.7872174);
   hJetShapeErrRatio0_Combined_copy__11->SetBinContent(9,0.7999338);
   hJetShapeErrRatio0_Combined_copy__11->SetBinError(1,0.01486676);
   hJetShapeErrRatio0_Combined_copy__11->SetBinError(2,0.01362802);
   hJetShapeErrRatio0_Combined_copy__11->SetBinError(3,0.01356929);
   hJetShapeErrRatio0_Combined_copy__11->SetBinError(4,0.01468023);
   hJetShapeErrRatio0_Combined_copy__11->SetBinError(5,0.01809581);
   hJetShapeErrRatio0_Combined_copy__11->SetBinError(6,0.02177987);
   hJetShapeErrRatio0_Combined_copy__11->SetBinError(7,0.03083078);
   hJetShapeErrRatio0_Combined_copy__11->SetBinError(8,0.05087718);
   hJetShapeErrRatio0_Combined_copy__11->SetBinError(9,0.0775414);
   hJetShapeErrRatio0_Combined_copy__11->SetEntries(6931.739);
   hJetShapeErrRatio0_Combined_copy__11->SetDirectory(0);
   hJetShapeErrRatio0_Combined_copy__11->SetStats(0);
   return hJetShapeErrRatio0_Combined_copy__11;
}

TH1 *makeRatioElianeR02R04(){
        std::cout << "Calling ratio 0.4" << std::endl;

   Double_t xAxis12[10] = {20, 30, 40, 50, 60, 70, 80, 100, 120, 140}; 
   TH1D *hJetShapeErrRatio1_Combined_copy__14 = new TH1D("ratio04","Unfold hResponseMatrixMain",9, xAxis12);
   hJetShapeErrRatio1_Combined_copy__14->SetBinContent(1,0.3854477);
   hJetShapeErrRatio1_Combined_copy__14->SetBinContent(2,0.4706764);
   hJetShapeErrRatio1_Combined_copy__14->SetBinContent(3,0.5371839);
   hJetShapeErrRatio1_Combined_copy__14->SetBinContent(4,0.5688113);
   hJetShapeErrRatio1_Combined_copy__14->SetBinContent(5,0.5826412);
   hJetShapeErrRatio1_Combined_copy__14->SetBinContent(6,0.6053351);
   hJetShapeErrRatio1_Combined_copy__14->SetBinContent(7,0.6275919);
   hJetShapeErrRatio1_Combined_copy__14->SetBinContent(8,0.6678327);
   hJetShapeErrRatio1_Combined_copy__14->SetBinContent(9,0.6952574);
   hJetShapeErrRatio1_Combined_copy__14->SetBinError(1,0.01321523);
   hJetShapeErrRatio1_Combined_copy__14->SetBinError(2,0.01496935);
   hJetShapeErrRatio1_Combined_copy__14->SetBinError(3,0.01762163);
   hJetShapeErrRatio1_Combined_copy__14->SetBinError(4,0.02112995);
   hJetShapeErrRatio1_Combined_copy__14->SetBinError(5,0.02598604);
   hJetShapeErrRatio1_Combined_copy__14->SetBinError(6,0.02657974);
   hJetShapeErrRatio1_Combined_copy__14->SetBinError(7,0.03259574);
   hJetShapeErrRatio1_Combined_copy__14->SetBinError(8,0.04861144);
   hJetShapeErrRatio1_Combined_copy__14->SetBinError(9,0.06397007);
   hJetShapeErrRatio1_Combined_copy__14->SetEntries(2252.41);
   hJetShapeErrRatio1_Combined_copy__14->SetDirectory(0);
   hJetShapeErrRatio1_Combined_copy__14->SetStats(0);
   return hJetShapeErrRatio1_Combined_copy__14;
}

TH1 *makeRatioElianeR02R05(){
        std::cout << "Calling ratio 0.5" << std::endl;

   Double_t xAxis15[10] = {20, 30, 40, 50, 60, 70, 80, 100, 120, 140}; 
   TH1D *hJetShapeErrRatio2_Combined_copy__17 = new TH1D("ratio05","Unfold hResponseMatrixMain",9, xAxis15);
   hJetShapeErrRatio2_Combined_copy__17->SetBinContent(1,0.2660734);
   hJetShapeErrRatio2_Combined_copy__17->SetBinContent(2,0.3437315);
   hJetShapeErrRatio2_Combined_copy__17->SetBinContent(3,0.4094946);
   hJetShapeErrRatio2_Combined_copy__17->SetBinContent(4,0.4478253);
   hJetShapeErrRatio2_Combined_copy__17->SetBinContent(5,0.4700201);
   hJetShapeErrRatio2_Combined_copy__17->SetBinContent(6,0.4899986);
   hJetShapeErrRatio2_Combined_copy__17->SetBinContent(7,0.5104567);
   hJetShapeErrRatio2_Combined_copy__17->SetBinContent(8,0.5404055);
   hJetShapeErrRatio2_Combined_copy__17->SetBinContent(9,0.5565742);
   hJetShapeErrRatio2_Combined_copy__17->SetBinError(1,0.01095917);
   hJetShapeErrRatio2_Combined_copy__17->SetBinError(2,0.01811726);
   hJetShapeErrRatio2_Combined_copy__17->SetBinError(3,0.0254632);
   hJetShapeErrRatio2_Combined_copy__17->SetBinError(4,0.02964427);
   hJetShapeErrRatio2_Combined_copy__17->SetBinError(5,0.0335036);
   hJetShapeErrRatio2_Combined_copy__17->SetBinError(6,0.03545507);
   hJetShapeErrRatio2_Combined_copy__17->SetBinError(7,0.04107909);
   hJetShapeErrRatio2_Combined_copy__17->SetBinError(8,0.0522426);
   hJetShapeErrRatio2_Combined_copy__17->SetBinError(9,0.0502014);
   hJetShapeErrRatio2_Combined_copy__17->SetEntries(2906.438);
   hJetShapeErrRatio2_Combined_copy__17->SetDirectory(0);
   hJetShapeErrRatio2_Combined_copy__17->SetStats(0);
   return hJetShapeErrRatio2_Combined_copy__17;
}

TH1 *makeRatioElianeR02R06(){
    std::cout << "Calling ratio 0.6" << std::endl;
   Double_t xAxis18[8] = {20, 30, 40, 50, 60, 70, 80, 100}; 

   TH1D *hJetShapeErrRatio3_Combined_copy__20 = new TH1D("ratio06","Unfold hResponseMatrixMain",7, xAxis18);
   hJetShapeErrRatio3_Combined_copy__20->SetBinContent(1,0.18047);
   hJetShapeErrRatio3_Combined_copy__20->SetBinContent(2,0.2595212);
   hJetShapeErrRatio3_Combined_copy__20->SetBinContent(3,0.3296293);
   hJetShapeErrRatio3_Combined_copy__20->SetBinContent(4,0.3719464);
   hJetShapeErrRatio3_Combined_copy__20->SetBinContent(5,0.3932187);
   hJetShapeErrRatio3_Combined_copy__20->SetBinContent(6,0.4143753);
   hJetShapeErrRatio3_Combined_copy__20->SetBinContent(7,0.4232948);
   hJetShapeErrRatio3_Combined_copy__20->SetBinError(1,0.009666973);
   hJetShapeErrRatio3_Combined_copy__20->SetBinError(2,0.01645076);
   hJetShapeErrRatio3_Combined_copy__20->SetBinError(3,0.02376053);
   hJetShapeErrRatio3_Combined_copy__20->SetBinError(4,0.02798476);
   hJetShapeErrRatio3_Combined_copy__20->SetBinError(5,0.03072326);
   hJetShapeErrRatio3_Combined_copy__20->SetBinError(6,0.03411301);
   hJetShapeErrRatio3_Combined_copy__20->SetBinError(7,0.03583911);
   hJetShapeErrRatio3_Combined_copy__20->SetEntries(2475.304);
   hJetShapeErrRatio3_Combined_copy__20->SetDirectory(0);
   hJetShapeErrRatio3_Combined_copy__20->SetStats(0);
   return hJetShapeErrRatio3_Combined_copy__20;
}

TH1 *makeRatioPowheg502R02R03(){
   Double_t xAxis11[10] = {20, 30, 40, 50, 60, 70, 80, 100, 120, 140}; 
   
   TH1D *hPOWHEGRatio0_copy__13 = new TH1D("powhegR03","R= 0.2",9, xAxis11);
   hPOWHEGRatio0_copy__13->SetBinContent(1,0.5688326);
   hPOWHEGRatio0_copy__13->SetBinContent(2,0.6180124);
   hPOWHEGRatio0_copy__13->SetBinContent(3,0.6618653);
   hPOWHEGRatio0_copy__13->SetBinContent(4,0.6907244);
   hPOWHEGRatio0_copy__13->SetBinContent(5,0.712804);
   hPOWHEGRatio0_copy__13->SetBinContent(6,0.7299621);
   hPOWHEGRatio0_copy__13->SetBinContent(7,0.7449899);
   hPOWHEGRatio0_copy__13->SetBinContent(8,0.7618115);
   hPOWHEGRatio0_copy__13->SetBinContent(9,0.7692643);
   hPOWHEGRatio0_copy__13->SetBinError(1,0.008746358);
   hPOWHEGRatio0_copy__13->SetBinError(2,0.004494592);
   hPOWHEGRatio0_copy__13->SetBinError(3,0.00414393);
   hPOWHEGRatio0_copy__13->SetBinError(4,0.004419708);
   hPOWHEGRatio0_copy__13->SetBinError(5,0.004993905);
   hPOWHEGRatio0_copy__13->SetBinError(6,0.005744326);
   hPOWHEGRatio0_copy__13->SetBinError(7,0.007182706);
   hPOWHEGRatio0_copy__13->SetBinError(8,0.01013687);
   hPOWHEGRatio0_copy__13->SetBinError(9,0.01410981);
   hPOWHEGRatio0_copy__13->SetEntries(71893.48);
   hPOWHEGRatio0_copy__13->SetDirectory(0);
   hPOWHEGRatio0_copy__13->SetStats(0);
    return hPOWHEGRatio0_copy__13;
}

TH1 *makeRatioPowheg502R02R04(){
       Double_t xAxis14[10] = {20, 30, 40, 50, 60, 70, 80, 100, 120, 140}; 

       TH1D *hPOWHEGRatio1_copy__16 = new TH1D("hPOWHEGRatio1_copy__16","R= 0.2",9, xAxis14);
   hPOWHEGRatio1_copy__16->SetBinContent(1,0.3745392);
   hPOWHEGRatio1_copy__16->SetBinContent(2,0.4458915);
   hPOWHEGRatio1_copy__16->SetBinContent(3,0.4999032);
   hPOWHEGRatio1_copy__16->SetBinContent(4,0.5356383);
   hPOWHEGRatio1_copy__16->SetBinContent(5,0.5624891);
   hPOWHEGRatio1_copy__16->SetBinContent(6,0.5860004);
   hPOWHEGRatio1_copy__16->SetBinContent(7,0.60464);
   hPOWHEGRatio1_copy__16->SetBinContent(8,0.6288887);
   hPOWHEGRatio1_copy__16->SetBinContent(9,0.6397512);
   hPOWHEGRatio1_copy__16->SetBinError(1,0.006163893);
   hPOWHEGRatio1_copy__16->SetBinError(2,0.003470953);
   hPOWHEGRatio1_copy__16->SetBinError(3,0.003306904);
   hPOWHEGRatio1_copy__16->SetBinError(4,0.003617615);
   hPOWHEGRatio1_copy__16->SetBinError(5,0.004118721);
   hPOWHEGRatio1_copy__16->SetBinError(6,0.004805461);
   hPOWHEGRatio1_copy__16->SetBinError(7,0.006031543);
   hPOWHEGRatio1_copy__16->SetBinError(8,0.008651758);
   hPOWHEGRatio1_copy__16->SetBinError(9,0.01210285);
   hPOWHEGRatio1_copy__16->SetEntries(63986.93);
   hPOWHEGRatio1_copy__16->SetDirectory(0);
   hPOWHEGRatio1_copy__16->SetStats(0);

   return hPOWHEGRatio1_copy__16;
}

TH1 *makeRatioPowheg502R02R05(){
       Double_t xAxis17[10] = {20, 30, 40, 50, 60, 70, 80, 100, 120, 140}; 
   
   TH1D *hPOWHEGRatio2_copy__19 = new TH1D("hPOWHEGRatio2_copy__19","R= 0.2",9, xAxis17);
   hPOWHEGRatio2_copy__19->SetBinContent(1,0.2557508);
   hPOWHEGRatio2_copy__19->SetBinContent(2,0.337541);
   hPOWHEGRatio2_copy__19->SetBinContent(3,0.3949688);
   hPOWHEGRatio2_copy__19->SetBinContent(4,0.4344563);
   hPOWHEGRatio2_copy__19->SetBinContent(5,0.4637827);
   hPOWHEGRatio2_copy__19->SetBinContent(6,0.4874411);
   hPOWHEGRatio2_copy__19->SetBinContent(7,0.5110377);
   hPOWHEGRatio2_copy__19->SetBinContent(8,0.5352428);
   hPOWHEGRatio2_copy__19->SetBinContent(9,0.5551396);
   hPOWHEGRatio2_copy__19->SetBinError(1,0.006238315);
   hPOWHEGRatio2_copy__19->SetBinError(2,0.003362585);
   hPOWHEGRatio2_copy__19->SetBinError(3,0.003507627);
   hPOWHEGRatio2_copy__19->SetBinError(4,0.003297165);
   hPOWHEGRatio2_copy__19->SetBinError(5,0.003791471);
   hPOWHEGRatio2_copy__19->SetBinError(6,0.004440946);
   hPOWHEGRatio2_copy__19->SetBinError(7,0.005592778);
   hPOWHEGRatio2_copy__19->SetBinError(8,0.008029785);
   hPOWHEGRatio2_copy__19->SetBinError(9,0.01149681);
   hPOWHEGRatio2_copy__19->SetEntries(47114.3);
   hPOWHEGRatio2_copy__19->SetDirectory(0);
   hPOWHEGRatio2_copy__19->SetStats(0);

   return hPOWHEGRatio2_copy__19;
}

TH1 *makeRatioPowheg502R02R06(){
       Double_t xAxis20[8] = {20, 30, 40, 50, 60, 70, 80, 100}; 

   TH1D *hPOWHEGRatio3_copy__22 = new TH1D("hPOWHEGRatio3_copy__22","R= 0.2",7, xAxis20);
   hPOWHEGRatio3_copy__22->SetBinContent(1,0.1753221);
   hPOWHEGRatio3_copy__22->SetBinContent(2,0.2529452);
   hPOWHEGRatio3_copy__22->SetBinContent(3,0.3181035);
   hPOWHEGRatio3_copy__22->SetBinContent(4,0.3566509);
   hPOWHEGRatio3_copy__22->SetBinContent(5,0.3878871);
   hPOWHEGRatio3_copy__22->SetBinContent(6,0.4139478);
   hPOWHEGRatio3_copy__22->SetBinContent(7,0.4385861);
   hPOWHEGRatio3_copy__22->SetBinError(1,0.008944872);
   hPOWHEGRatio3_copy__22->SetBinError(2,0.009431796);
   hPOWHEGRatio3_copy__22->SetBinError(3,0.003981704);
   hPOWHEGRatio3_copy__22->SetBinError(4,0.003544575);
   hPOWHEGRatio3_copy__22->SetBinError(5,0.004002914);
   hPOWHEGRatio3_copy__22->SetBinError(6,0.004681703);
   hPOWHEGRatio3_copy__22->SetBinError(7,0.005940612);
   hPOWHEGRatio3_copy__22->SetEntries(20293.12);
   hPOWHEGRatio3_copy__22->SetDirectory(0);
   hPOWHEGRatio3_copy__22->SetStats(0);
    return hPOWHEGRatio3_copy__22;
}

void makeTheoryComparisonRatios(const std::string_view csratios, 
                                const std::string_view powhegfile, 
                                const std::string_view herwigfile){
    std::unique_ptr<TFile> reader(TFile::Open(csratios.data(), "READ")),
                           powhegreader(TFile::Open(powhegfile.data(), "READ")),
                           herwigreader(TFile::Open(herwigfile.data(), "READ"));
    
    std::map<int, std::function<TH1 * ()>> data502 = {{3, makeRatioElianeR02R03},{4, makeRatioElianeR02R04},{5, makeRatioElianeR02R05},{6, makeRatioElianeR02R06}};
    std::map<int, std::function<TH1 * ()>> powheg502 = {{3, makeRatioPowheg502R02R03},{4, makeRatioPowheg502R02R04},{5, makeRatioPowheg502R02R05},{6, makeRatioPowheg502R02R06}};
 
    auto plot = new ROOT6tools::TSavableCanvas("RatioComparisonToPowheg", "Comparison to powheg", 1500, 700);
    plot->Divide(2, 2);

    // Read reference POWHEG
    std::unique_ptr<TH1> powhegref, powhegrefrebinned, herwigref, herwigrefrebinned;
    powhegref = std::unique_ptr<TH1>(static_cast<TH1 *>(powhegreader->Get("SpectrumPowheg_R02")->Clone()));
    herwigref = std::unique_ptr<TH1>(static_cast<TH1 *>(herwigreader->Get("SpectrumHerwig_R02")->Clone()));

    int ipad(0);
    for(auto r : ROOT::TSeqI(3, 7)) {
        std::string dirstring(Form("R02R%02d", r));
        plot->cd(ipad+1);
        gPad->SetLeftMargin(0.15);
        auto frame = new ROOT6tools::TAxisFrame(Form("frameR%02d", r), "p_{t} (GeV/c)", Form("d#sigma(R=0.2)/(dp_{t}dy) / d#sigma(R=%.1f)/(dp_{t}dy)", double(r)/10.), 0, 350, 0., 1.2);
        frame->Draw("axis");
        TLegend *leg(nullptr);
        if(!ipad) {
            leg = new ROOT6tools::TDefaultLegend(0.65, 0.15, 0.89, 0.5);
            leg->Draw();
        }
        reader->cd(dirstring.data());
        auto spec = static_cast<TH1*>(gDirectory->Get(Form("stat_%s", dirstring.data())));
        auto ucorr = static_cast<TH1 *>(gDirectory->Get(Form("correlatedUncertainty_%s", dirstring.data()))),
             ushape = static_cast<TH1 *>(gDirectory->Get(Form("shapeUncertainty_%s", dirstring.data())));
        spec->SetMarkerStyle(20);
        spec->SetMarkerColor(kBlack);
        spec->SetLineColor(kBlack);
        spec->Draw("epsame");
        ucorr->SetLineColor(kBlack);
        ucorr->SetFillStyle(0);
        ushape->SetFillColor(kGray);
        ushape->SetFillStyle(3001);
        ucorr->Draw("2same");
        ushape->Draw("2same");
        if(leg) {
            leg->AddEntry(spec, "ALICE, pp #sqrt{s} = 13 TeV", "lep");
            leg->AddEntry(ucorr, "Corr. Uncertainty", "F");
            leg->AddEntry(ushape, "Shape. Uncertainty", "F");
        }

        auto ratio502 = data502[r]();
        ratio502->SetMarkerColor(kGreen+2);
        ratio502->SetLineColor(kGreen+2);
        ratio502->SetMarkerStyle(21);
        ratio502->Draw("epsame");
        if(leg) leg->AddEntry(ratio502, "ALICE, pp #sqrt{s} = 5.02 TeV", "lep");

        // POWHEG+PYTHIA
        auto powhegraw = static_cast<TH1 *>(powhegreader->Get(Form("SpectrumPowheg_R%02d",r)));
        auto powhegrebinned = powhegraw->Rebin(spec->GetXaxis()->GetNbins(), Form("powheg_rebinned_%s", dirstring.data()), spec->GetXaxis()->GetXbins()->GetArray());
        powhegrebinned->Scale(1., "width");
        powhegrebinned->SetDirectory(nullptr);
        if(!powhegrefrebinned){
            powhegrefrebinned = std::unique_ptr<TH1>(powhegref->Rebin(spec->GetXaxis()->GetNbins(), Form("powhegRaw_rebinned_%s", dirstring.data()), spec->GetXaxis()->GetXbins()->GetArray()));
            powhegrefrebinned->Scale(1., "width");
        }
        auto pwhgratio = new Ratio(powhegrefrebinned.get(), powhegrebinned);
        Style{kBlue, 24}.SetStyle<Ratio>(*pwhgratio);
        pwhgratio->Draw("epsame");
        if(leg) leg->AddEntry(pwhgratio, "POWHEG+PYTHIA6", "lep");

        // HERWIG7
        auto herwigraw = static_cast<TH1 *>(herwigreader->Get(Form("SpectrumHerwig_R%02d",r)));
        auto herwigrebinned = herwigraw->Rebin(spec->GetXaxis()->GetNbins(), Form("powheg_rebinned_%s", dirstring.data()), spec->GetXaxis()->GetXbins()->GetArray());
        herwigrebinned->Scale(1., "width");
        herwigrebinned->SetDirectory(nullptr);
        if(!herwigrefrebinned){
            herwigrefrebinned = std::unique_ptr<TH1>(herwigref->Rebin(spec->GetXaxis()->GetNbins(), Form("powhegRaw_rebinned_%s", dirstring.data()), spec->GetXaxis()->GetXbins()->GetArray()));
            herwigrefrebinned->Scale(1., "width");
        }
        auto hwgratio = new Ratio(herwigrefrebinned.get(), herwigrebinned);
        Style{kRed, 24}.SetStyle<Ratio>(*hwgratio);
        hwgratio->Draw("epsame");
        if(leg) leg->AddEntry(hwgratio, "Herwig", "lep");

        auto rpowheg502 = powheg502[r]();
        rpowheg502->SetMarkerColor(kMagenta);
        rpowheg502->SetLineColor(kMagenta);
        rpowheg502->SetMarkerStyle(27);
        rpowheg502->Draw("epsame");
        if(leg) leg->AddEntry(rpowheg502, "POWHEG+PYTHIA8 #sqrt{s} = 5.02 TeV", "lep");

        ipad++;
    } 
    plot->cd();
    plot->Update();
    plot->SaveCanvas(plot->GetName());
}